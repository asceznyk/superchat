import uuid

from typing import Dict

from fastapi import APIRouter, HTTPException, Cookie, Depends
from fastapi.responses import JSONResponse

from app.models.states import UserProfile
from app.core.config import Settings
from app.services.auth import create_token, verify_token, get_current_user

settings = Settings()

router = APIRouter()

@router.get("/me", response_model=UserProfile)
def user_profile_info(user:Dict=Depends(get_current_user)):
  if not user['authenticated']:
    raise HTTPException(status_code=400, detail="token is not verified")
  return UserProfile(
    name = user['name'],
    email = user['email']
  )

@router.get("/refresh")
def refresh_session_token(
  session_refresh:str=Cookie(default=None)
) -> JSONResponse:
  if not session_refresh:
    raise HTTPException(status_code=401, detail="Missing refresh token")
  info = verify_token(session_refresh, token_type='refresh')
  success = {"set": True}
  access_token, refresh_token = issue_jwt_pair(info)
  resp = JSONResponse(content=success)
  resp.set_cookie(
    key="session_id",
    value=access_token,
    httponly=True,
    samesite="lax"
  )
  return resp


